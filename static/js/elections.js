// Generated by CoffeeScript 1.8.0
(function() {
  var deleteElection;

  jQuery(function() {
    console.log('Election script ran!');
    $('#add-election-button').click((function(_this) {
      return function(e) {
        var field, fields, postData, _i, _len, field_names;
        e.preventDefault();
        field_names = ['Title of Election', 'Email', 'Deadline', 'Organization'];
        fields = [$('#input-title'), $('#input-email'), $('#input-date'), $('#input-organization')];
        for (_i = 0, _len = fields.length; _i < _len; _i++) {
          field = fields[_i];
          if (field.val().trim() === "") {
            alert('Missing: ' + field_names[_i]);
            return;
          }
        }
        
        //Checks if date_expired is later than today's date
        var date1 = new Date($('#input-date').val());
        var today = new Date();  
        if (date1 <= today) {
          alert("Date expired must be later than today's date");
          return;
        }
        
		//Checks if email is valid
        if (checkEmail($('#input-email').val()) == false) {
          alert('Invalid Email');
          return
        }
        
        postData = {
          'title': fields[0].val(),
          'email': fields[1].val(),
          'date_expired': fields[2].val(),
          'organization': fields[3].val()
        };
        return $.ajax({
          url: '/elections',
          type: 'POST',
          data: {
            'data': JSON.stringify(postData)
          },
          success: function(data) {
            var html, response;
            response = JSON.parse(data);
            
            if (response['id'] == 'Duplicate Election') {
              return alert('Duplicate Election');
            }
            else {
              html = $("<div class='alert' data-id='" + response['id'] + "'> <button type='button' class='close deleteElection' data-dismiss='alert'>"+
							"&times;</button><h4><b>" + response['title'] + "</b> is hosted by " + response['organization'] + " and expires on "
							+ response['date_expired'] + "</h4> </div><div id='" + response['title'].replace(/\s/g,'') + "'> </div>");
              
              $('#elections').prepend(html);
              
              html.hide().slideDown(500);
              return html.children('button[class="close deleteElection"]').click(deleteElection);
            }
          }
        });
      };
    })(this));
    $('button[class="close deleteElection"]').click(deleteElection);
  });

  deleteElection = function(e) {
    var election, election_id;
    election = $(this).parent();
    election_id = election.attr('data-id');
    return $.ajax({
      url: '/elections/delete',
      type: 'POST',
      data: {
        'id': election_id
      },
      success: function(data) {
				console.log(data);
        if (data === 'Success!') {
          return election.slideUp(500);
        }
				if (data === 'Please delete all asosociated positions before deleting the election') {
					return alert('Please delete all asosociated positions before deleting the election')
				}
      }
    });
  };

}).call(this);

function checkEmail(emailAddress) {
  var sQtext = '[^\\x0d\\x22\\x5c\\x80-\\xff]';
  var sDtext = '[^\\x0d\\x5b-\\x5d\\x80-\\xff]';
  var sAtom = '[^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+';
  var sQuotedPair = '\\x5c[\\x00-\\x7f]';
  var sDomainLiteral = '\\x5b(' + sDtext + '|' + sQuotedPair + ')*\\x5d';
  var sQuotedString = '\\x22(' + sQtext + '|' + sQuotedPair + ')*\\x22';
  var sDomain_ref = sAtom;
  var sSubDomain = '(' + sDomain_ref + '|' + sDomainLiteral + ')';
  var sWord = '(' + sAtom + '|' + sQuotedString + ')';
  var sDomain = sSubDomain + '(\\x2e' + sSubDomain + ')*';
  var sLocalPart = sWord + '(\\x2e' + sWord + ')*';
  var sAddrSpec = sLocalPart + '\\x40' + sDomain; // complete RFC822 email address spec
  var sValidEmail = '^' + sAddrSpec + '$'; // as whole string

  var reValidEmail = new RegExp(sValidEmail);

  return reValidEmail.test(emailAddress);
}